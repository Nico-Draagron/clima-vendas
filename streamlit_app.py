# ============================================================================
# üéØ streamlit_app.py - ARQUIVO PRINCIPAL INTEGRADO
# ============================================================================

import streamlit as st
import pandas as pd
import numpy as np
import os
import sys
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="üå§Ô∏è Clima x Vendas - Sistema Preditivo",
    page_icon="üå§Ô∏è",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Adicionar diret√≥rio atual ao path para imports
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.append(current_dir)

# Imports dos m√≥dulos do sistema
try:
    from auth.auth_system import SimpleAuthenticator
    from data.store_manager import StoreDataManager
    from pages.admin import AdminPage
    from pages.dashboard_preditivo import add_prediction_widgets_to_dashboard
    
    # Imports das p√°ginas principais
    from pages.clima_vendas import show_clima_vendas_page
    from pages.modelo_preditivo import show_modelo_preditivo_page
    from pages.serie_temporal import show_serie_temporal_page
    from pages.previsao_climatica import show_previsao_climatica_page
    
    IMPORTS_OK = True
except ImportError as e:
    st.error(f"‚ùå Erro ao importar m√≥dulos: {e}")
    st.info("‚ÑπÔ∏è Verifique se todos os arquivos est√£o no local correto")
    IMPORTS_OK = False

# ============================================================================
# üîß INICIALIZA√á√ÉO DO SISTEMA
# ============================================================================

def initialize_system():
    """Inicializa componentes do sistema"""
    
    if not IMPORTS_OK:
        return None, None
    
    # Inicializar authenticator
    auth = SimpleAuthenticator()
    
    # Inicializar store manager
    store_manager = StoreDataManager()
    
    return auth, store_manager

# ============================================================================
# üîê SISTEMA DE AUTENTICA√á√ÉO
# ============================================================================

def show_login_page():
    """P√°gina de login"""
    
    st.markdown("""
    <div style="text-align: center; padding: 2rem;">
        <h1>üå§Ô∏è Sistema Clima x Vendas</h1>
        <h3>Sistema Inteligente de An√°lise Preditiva</h3>
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        st.markdown("### üîê Login")
        
        with st.form("login_form"):
            username = st.text_input("üë§ Usu√°rio")
            password = st.text_input("üîí Senha", type="password")
            submit_button = st.form_submit_button("üöÄ Entrar", type="primary")
            
            if submit_button:
                auth = st.session_state.get('authenticator')
                if auth and auth.login(username, password):
                    st.success("‚úÖ Login realizado com sucesso!")
                    st.rerun()
                else:
                    st.error("‚ùå Usu√°rio ou senha incorretos")
        
        # Informa√ß√µes de login para demo
        st.markdown("---")
        st.markdown("### üß™ Demo - Credenciais de Teste")
        
        col_admin, col_user = st.columns(2)
        
        with col_admin:
            st.info("""
            **üëë Administrador:**
            - Usu√°rio: `admin`
            - Senha: `admin123`
            - Acesso completo
            """)
        
        with col_user:
            st.info("""
            **üë§ Usu√°rio:**
            - Usu√°rio: `usuario`
            - Senha: `user123`
            - Acesso b√°sico
            """)

# ============================================================================
# üìä DASHBOARD PRINCIPAL
# ============================================================================

def show_dashboard_page(df, role, store_manager, auth_manager, selected_store_id):
    """Dashboard principal com integra√ß√£o preditiva"""
    
    st.header("üìä Dashboard Principal")
    
    if df is None:
        st.warning("‚ö†Ô∏è Selecione um dataset no menu lateral")
        return
    
    # Verificar coluna de vendas
    stores = store_manager.get_available_stores()
    if selected_store_id not in stores:
        st.error("‚ùå Loja selecionada n√£o encontrada")
        return
    
    store_info = stores[selected_store_id]
    value_col = store_info['value_column']
    
    if value_col not in df.columns:
        st.error(f"‚ùå Coluna de vendas '{value_col}' n√£o encontrada nos dados")
        return
    
    # M√©tricas principais
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        total_vendas = df[value_col].sum()
        st.metric("üí∞ Total Vendas", f"R$ {total_vendas:,.2f}".replace(',', '.'))
    
    with col2:
        st.metric("üìÖ Per√≠odo", f"{len(df)} dias")
    
    with col3:
        media_vendas = df[value_col].mean()
        st.metric("üìä M√©dia Di√°ria", f"R$ {media_vendas:,.2f}".replace(',', '.'))
    
    with col4:
        if 'precipitacao_total' in df.columns:
            dias_chuva = (df['precipitacao_total'] > 0).sum()
            st.metric("üåßÔ∏è Dias com Chuva", f"{dias_chuva}")
        else:
            st.metric("üåßÔ∏è Dados de Chuva", "N/A")
    
    # Gr√°fico de evolu√ß√£o das vendas
    if 'data' in df.columns:
        st.subheader("üìà Evolu√ß√£o das Vendas")
        
        import plotly.express as px
        
        df_plot = df.copy()
        df_plot['data'] = pd.to_datetime(df_plot['data'])
        
        fig = px.line(
            df_plot, 
            x='data', 
            y=value_col,
            title="Faturamento Di√°rio ao Longo do Tempo"
        )
        fig.update_layout(
            xaxis_title="Data",
            yaxis_title="Faturamento (R$)",
            hovermode="x unified",
            height=500
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # ü§ñ INTEGRA√á√ÉO DOS WIDGETS PREDITIVOS
    if IMPORTS_OK:
        add_prediction_widgets_to_dashboard(store_manager, auth_manager, selected_store_id)
    
    # An√°lise r√°pida por dia da semana
    if 'data' in df.columns:
        st.subheader("üìÖ An√°lise por Dia da Semana")
        
        df_analysis = df.copy()
        df_analysis['data'] = pd.to_datetime(df_analysis['data'])
        df_analysis['dia_semana'] = df_analysis['data'].dt.dayofweek
        df_analysis['nome_dia'] = df_analysis['dia_semana'].map({
            0: 'Segunda', 1: 'Ter√ßa', 2: 'Quarta', 3: 'Quinta',
            4: 'Sexta', 5: 'S√°bado', 6: 'Domingo'
        })
        
        weekday_stats = df_analysis.groupby('nome_dia')[value_col].agg(['mean', 'count']).round(2)
        weekday_stats = weekday_stats.reindex([
            'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'
        ])
        weekday_stats.columns = ['Vendas M√©dias (R$)', 'N√∫mero de Dias']
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.dataframe(weekday_stats, use_container_width=True)
        
        with col2:
            fig_weekday = px.bar(
                x=weekday_stats.index,
                y=weekday_stats['Vendas M√©dias (R$)'],
                title="Vendas M√©dias por Dia da Semana",
                labels={'x': 'Dia da Semana', 'y': 'Vendas M√©dias (R$)'}
            )
            st.plotly_chart(fig_weekday, use_container_width=True)
    
    # Informa√ß√µes espec√≠ficas por role
    if role == "admin":
        st.subheader("üîí Informa√ß√µes Confidenciais (Admin Only)")
        st.info("Esta se√ß√£o s√≥ √© vis√≠vel para administradores")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("üéØ Maior Venda", f"R$ {df[value_col].max():,.2f}".replace(',', '.'))
        with col2:
            st.metric("üìâ Menor Venda", f"R$ {df[value_col].min():,.2f}".replace(',', '.'))
        with col3:
            cv = df[value_col].std() / df[value_col].mean()
            st.metric("üìä Coef. Varia√ß√£o", f"{cv:.3f}")

# ============================================================================
# üéÆ INTERFACE PRINCIPAL
# ============================================================================

def show_main_app():
    """Interface principal do aplicativo"""
    
    auth = st.session_state.get('authenticator')
    store_manager = st.session_state.get('store_manager')
    
    if not auth or not store_manager:
        st.error("‚ùå Erro na inicializa√ß√£o do sistema")
        return
    
    user_info = auth.get_user_info()
    username = user_info.get('name', 'Usu√°rio')
    role = user_info.get('role', 'user')
    
    # Sidebar com navega√ß√£o
    with st.sidebar:
        st.markdown(f"### üëã Ol√°, {username}!")
        st.markdown(f"**Role:** {role.upper()}")
        
        st.markdown("---")
        
        # Sele√ß√£o de loja
        st.markdown("### üè™ Sele√ß√£o de Loja")
        
        stores = store_manager.get_available_stores()
        
        if stores:
            store_options = {f"{info['display_name']} ({store_id})": store_id 
                           for store_id, info in stores.items()}
            
            selected_display = st.selectbox(
                "Escolha uma loja:",
                options=list(store_options.keys()),
                key="store_selector"
            )
            
            selected_store_id = store_options[selected_display]
            
            # Carregar dados da loja selecionada
            with st.spinner("Carregando dados..."):
                df = store_manager.load_store_data(selected_store_id)
            
            if df is not None:
                st.success(f"‚úÖ {len(df)} registros carregados")
                
                # Informa√ß√µes da loja
                store_info = stores[selected_store_id]
                st.markdown(f"**üìä Coluna de Vendas:** {store_info['value_column']}")
                
                if not df.empty:
                    date_range = f"{df['data'].min().strftime('%d/%m/%Y')} - {df['data'].max().strftime('%d/%m/%Y')}"
                    st.markdown(f"**üìÖ Per√≠odo:** {date_range}")
            else:
                st.error("‚ùå Erro ao carregar dados")
                df = None
        else:
            st.warning("‚ö†Ô∏è Nenhuma loja configurada")
            selected_store_id = None
            df = None
        
        st.markdown("---")
        
        # Menu de navega√ß√£o
        st.markdown("### üìã Menu de Navega√ß√£o")
        
        # Op√ß√µes baseadas no role
        menu_options = [
            "üìä Dashboard",
            "üå§Ô∏è Clima x Vendas",
            "üìà S√©rie Temporal",
            "ü§ñ Modelo Preditivo",
            "üîÆ Previs√£o Clim√°tica"
        ]
        
        if role == "admin":
            menu_options.append("‚öôÔ∏è Administra√ß√£o")
        
        selected_page = st.radio("Escolha uma p√°gina:", menu_options)
        
        st.markdown("---")
        
        # Informa√ß√µes do sistema
        st.markdown("### ‚ÑπÔ∏è Sistema")
        st.markdown(f"""
        **Vers√£o:** 2.0.0  
        **√öltima Atualiza√ß√£o:** {datetime.now().strftime('%d/%m/%Y')}  
        **Status:** üü¢ Online
        """)
        
        # Logout
        if st.button("üö™ Logout", type="secondary"):
            auth.logout()
            st.rerun()
    
    # Conte√∫do principal baseado na sele√ß√£o
    if selected_page == "üìä Dashboard":
        show_dashboard_page(df, role, store_manager, auth, selected_store_id)
    
    elif selected_page == "üå§Ô∏è Clima x Vendas":
        if IMPORTS_OK and df is not None:
            show_clima_vendas_page(df, role, store_manager)
        else:
            st.error("‚ùå Dados n√£o dispon√≠veis ou m√≥dulo n√£o encontrado")
    
    elif selected_page == "üìà S√©rie Temporal":
        if IMPORTS_OK and df is not None:
            show_serie_temporal_page(df, role, store_manager)
        else:
            st.error("‚ùå Dados n√£o dispon√≠veis ou m√≥dulo n√£o encontrado")
    
    elif selected_page == "ü§ñ Modelo Preditivo":
        if IMPORTS_OK and df is not None:
            show_modelo_preditivo_page(df, role, store_manager, auth)
        else:
            st.error("‚ùå Dados n√£o dispon√≠veis ou m√≥dulo n√£o encontrado")
    
    elif selected_page == "üîÆ Previs√£o Clim√°tica":
        if IMPORTS_OK and df is not None:
            show_previsao_climatica_page(df, role, store_manager)
        else:
            st.error("‚ùå Dados n√£o dispon√≠veis ou m√≥dulo n√£o encontrado")
    
    elif selected_page == "‚öôÔ∏è Administra√ß√£o" and role == "admin":
        if IMPORTS_OK:
            admin_page = AdminPage(auth)
            admin_page.render()
        else:
            st.error("‚ùå M√≥dulo administrativo n√£o encontrado")

# ============================================================================
# üéØ FUN√á√ÉO PRINCIPAL
# ============================================================================

def main():
    """Fun√ß√£o principal da aplica√ß√£o"""
    
    # Inicializar sistema se n√£o existir na sess√£o
    if 'authenticator' not in st.session_state or 'store_manager' not in st.session_state:
        auth, store_manager = initialize_system()
        
        if auth is None or store_manager is None:
            st.error("‚ùå Falha na inicializa√ß√£o do sistema")
            st.stop()
        
        st.session_state['authenticator'] = auth
        st.session_state['store_manager'] = store_manager
    
    # Verificar se usu√°rio est√° logado
    auth = st.session_state['authenticator']
    
    if auth.is_logged_in():
        show_main_app()
    else:
        show_login_page()

# ============================================================================
# üöÄ PONTO DE ENTRADA
# ============================================================================

if __name__ == "__main__":
    main()