# ============================================================================
# üìÅ streamlit_app.py - ARQUIVO PRINCIPAL CORRIGIDO
# ============================================================================
import streamlit as st
import pandas as pd
import os
import sys
from pathlib import Path

# Adicionar o diret√≥rio raiz ao path para importa√ß√µes
root_path = Path(__file__).parent
sys.path.append(str(root_path))

# Configura√ß√£o da p√°gina inicial
st.set_page_config(
    page_title="Dashboard Clima x Vendas",
    page_icon="üå§Ô∏è",
    layout="wide",
    initial_sidebar_state="collapsed"  # fun√ßao para esconder menu laterel na tela de login.
)

# CSS profissional para login
st.markdown("""
<style>
    /* Esconder elementos do Streamlit durante login */
    .main > div:first-child {
        padding-top: 0rem;
    }
    
    /* Estilo do container de login */
    .login-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    
    /* Header do login */
    .login-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .login-header h1 {
        color: #2c3e50;
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
    }
    
    .login-header p {
        color: #7f8c8d;
        font-size: 1.1rem;
    }
    
    /* Estilo dos inputs */
    .stTextInput > div > div > input {
        border-radius: 8px;
        border: 2px solid #ecf0f1;
        padding: 12px;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }
    
    .stTextInput > div > div > input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    /* Bot√£o de login */
    .stButton > button {
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* Card de usu√°rios demo */
    .demo-users {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 2rem;
        border-left: 4px solid #3498db;
    }
    
    .demo-users h4 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }
    
    .user-demo {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        border: 1px solid #e0e0e0;
    }
    
    /* Esconder elementos desnecess√°rios */
    #MainMenu, footer, header {
        visibility: hidden;
    }
    
    .stDeployButton {
        visibility: hidden;
    }
    
    /* Background gradient */
    .stApp {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    /* Container principal */
    .main .block-container {
        padding: 3rem 1rem;
    }
    
    /* Mensagens de erro/sucesso */
    .stAlert {
        border-radius: 8px;
        margin: 1rem 0;
    }
    
    /* Loading animation */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50px;
    }
    
    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
""", unsafe_allow_html=True)

class SimpleAuthenticator:
    """Sistema de autentica√ß√£o simples e robusto"""
    
    def __init__(self):
        self.users = {
            'admin': {
                'password': 'admin123',
                'name': 'Administrador',
                'email': 'admin@empresa.com',
                'role': 'admin'
            },
            'usuario': {
                'password': 'user123', 
                'name': 'Usu√°rio Comum',
                'email': 'usuario@empresa.com',
                'role': 'user'
            },
            'gerente': {
                'password': 'gerente123',
                'name': 'Gerente Regional', 
                'email': 'gerente@empresa.com',
                'role': 'manager'
            }
        }
    
    def authenticate(self, username, password):
        """Autentica usu√°rio"""
        if username in self.users:
            if self.users[username]['password'] == password:
                return True, self.users[username]
        return False, None
    
    def is_logged_in(self):
        """Verifica se usu√°rio est√° logado"""
        return st.session_state.get('authenticated', False)
    
    def get_user_info(self):
        """Retorna informa√ß√µes do usu√°rio logado"""
        return st.session_state.get('user_info', {})
    
    def login(self, username, user_info):
        """Realiza login do usu√°rio"""
        st.session_state['authenticated'] = True
        st.session_state['username'] = username
        st.session_state['user_info'] = user_info
    
    def logout(self):
        """Realiza logout"""
        for key in ['authenticated', 'username', 'user_info']:
            if key in st.session_state:
                del st.session_state[key]

def show_login_page():
    """Tela de login profissional"""
    
    # Container centralizado
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        st.markdown("""
        <div class="login-container">
            <div class="login-header">
                <h1>üå§Ô∏è Clima & Vendas</h1>
                <p>Sistema de An√°lise Preditiva</p>
            </div>
        """, unsafe_allow_html=True)
        
        # Inicializar authenticator
        auth = SimpleAuthenticator()
        
        # Formul√°rio de login
        with st.form("login_form", clear_on_submit=False):
            username = st.text_input(
                "üë§ Usu√°rio", 
                placeholder="Digite seu usu√°rio",
                key="login_username"
            )
            password = st.text_input(
                "üîí Senha", 
                type="password",
                placeholder="Digite sua senha",
                key="login_password"
            )
            
            col_btn1, col_btn2 = st.columns([1, 1])
            with col_btn1:
                login_button = st.form_submit_button("üöÄ Entrar", use_container_width=True)
            with col_btn2:
                demo_button = st.form_submit_button("üëÅÔ∏è Demo", use_container_width=True)
        
        # Processar login
        if login_button:
            if username and password:
                with st.spinner("Verificando credenciais..."):
                    success, user_info = auth.authenticate(username, password)
                    
                    if success:
                        auth.login(username, user_info)
                        st.success("‚úÖ Login realizado com sucesso!")
                        st.rerun()
                    else:
                        st.error("‚ùå Usu√°rio ou senha incorretos!")
            else:
                st.error("‚ö†Ô∏è Preencha usu√°rio e senha!")
        
        # Auto-login demo
        if demo_button:
            success, user_info = auth.authenticate('admin', 'admin123')
            auth.login('admin', user_info)
            st.success("‚úÖ Logado como Admin (Demo)")
            st.rerun()
        
        # Card com usu√°rios de demonstra√ß√£o
        st.markdown("""
            <div class="demo-users">
                <h4>üë• Usu√°rios para Teste</h4>
                
                <div class="user-demo">
                    <strong>üîë Administrador</strong><br>
                    <small>Usu√°rio: <code>admin</code> | Senha: <code>admin123</code></small><br>
                    <em>Acesso total aos dados e funcionalidades</em>
                </div>
                
                <div class="user-demo">
                    <strong>üë§ Usu√°rio Comum</strong><br>
                    <small>Usu√°rio: <code>usuario</code> | Senha: <code>user123</code></small><br>
                    <em>Acesso limitado a datasets espec√≠ficos</em>
                </div>
                
                <div class="user-demo">
                    <strong>üë®‚Äçüíº Gerente</strong><br>
                    <small>Usu√°rio: <code>gerente</code> | Senha: <code>gerente123</code></small><br>
                    <em>Acesso a relat√≥rios gerenciais</em>
                </div>
            </div>
        """, unsafe_allow_html=True)
        
        st.markdown("</div>", unsafe_allow_html=True)
    
    # Footer
    st.markdown("""
    <div style="text-align: center; margin-top: 3rem; color: white;">
        <p>üîê Sistema Seguro | üåü Desenvolvido com Streamlit</p>
    </div>
    """, unsafe_allow_html=True)

def show_main_app():
    """Aplica√ß√£o principal ap√≥s login"""
    
    auth = SimpleAuthenticator()
    user_info = auth.get_user_info()
    username = st.session_state.get('username', '')
    
    # Reconfigurar p√°gina para app principal
    st.markdown("""
    <style>
        .stApp {
            background: #ffffff;
        }
        
        .main .block-container {
            padding: 1rem;
        }
        
        #MainMenu, footer, header {
            visibility: visible;
        }
        
        .stDeployButton {
            visibility: visible;
        }
    </style>
    """, unsafe_allow_html=True)
    
    # Header da aplica√ß√£o
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        st.markdown("# üå§Ô∏è Dashboard Clima x Vendas")
        st.markdown("**Sistema de An√°lise Preditiva**")
    
    with col2:
        # Informa√ß√µes do usu√°rio
        role_colors = {
            'admin': '#e74c3c',
            'manager': '#f39c12', 
            'user': '#27ae60'
        }
        role_icons = {
            'admin': 'üëë',
            'manager': 'üë®‚Äçüíº',
            'user': 'üë§'
        }
        
        role = user_info.get('role', 'user')
        color = role_colors.get(role, '#95a5a6')
        icon = role_icons.get(role, 'üë§')
        
        st.markdown(f"""
        <div style="
            background: {color}; 
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: 10px; 
            text-align: center;
            margin: 1rem 0;
        ">
            <strong>{icon} {user_info.get('name', 'Usu√°rio')}</strong><br>
            <small>{role.upper()}</small>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        if st.button("üö™ Logout", use_container_width=True):
            auth.logout()
            st.rerun()
    
    st.markdown("---")
    
    # Sidebar para navega√ß√£o
    with st.sidebar:
        st.markdown("### üß≠ Navega√ß√£o")
        
        # Op√ß√µes baseadas no role
        options = ["üìä Dashboard"]
        
        if role in ['admin', 'manager', 'user']:
            options.extend(["üå§Ô∏è Clima x Vendas", "üìà S√©rie Temporal"])
        
        if role in ['admin', 'manager']:
            options.append("ü§ñ Modelo Preditivo")
        
        if role == 'admin':
            options.append("‚öôÔ∏è Administra√ß√£o")
        
        selected_page = st.radio("Escolha uma op√ß√£o:", options)
        
        st.markdown("---")
        
        # Informa√ß√µes do sistema
        st.markdown("### ‚ÑπÔ∏è Sistema")
        st.info(f"""
        **Usu√°rio:** {username}  
        **Role:** {role.upper()}  
        **Sess√£o:** Ativa
        """)
    
    # Conte√∫do principal baseado na sele√ß√£o
    if selected_page == "üìä Dashboard":
        show_dashboard(user_info)
    elif selected_page == "üå§Ô∏è Clima x Vendas":
        show_clima_vendas(user_info)
    elif selected_page == "üìà S√©rie Temporal":
        show_serie_temporal(user_info)
    elif selected_page == "ü§ñ Modelo Preditivo":
        show_modelo_preditivo(user_info)
    elif selected_page == "‚öôÔ∏è Administra√ß√£o":
        show_admin_panel(user_info)

def show_dashboard(user_info):
    """Dashboard principal"""
    st.header("üìä Dashboard Principal")
    
    role = user_info.get('role', 'user')
    
    # M√©tricas simuladas
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üí∞ Vendas Totais", "R$ 1.234.567", "+12%")
    
    with col2:
        st.metric("üìÖ Per√≠odo", "365 dias", "")
    
    with col3:
        if role == 'admin':
            st.metric("üíµ Lucro L√≠quido", "R$ 234.567", "+8%")
        else:
            st.metric("üìä M√©dia Di√°ria", "R$ 3.382", "+5%")
    
    with col4:
        st.metric("üåßÔ∏è Dias de Chuva", "127 dias", "-3%")
    
    # Gr√°fico simples
    st.subheader("üìà Evolu√ß√£o das Vendas")
    
    # Dados simulados
    import numpy as np
    dates = pd.date_range('2024-01-01', periods=30, freq='D')
    values = np.random.normal(3000, 500, 30)
    df_demo = pd.DataFrame({'Data': dates, 'Vendas': values})
    
    st.line_chart(df_demo.set_index('Data'))
    
    # Informa√ß√µes espec√≠ficas por role
    if role == 'admin':
        st.subheader("üîí Informa√ß√µes Confidenciais")
        st.success("Voc√™ tem acesso completo a todos os dados financeiros.")
        
        col1, col2 = st.columns(2)
        with col1:
            st.metric("üíé Maior Venda", "R$ 45.678")
        with col2:
            st.metric("üìâ Menor Venda", "R$ 1.234")
    
    elif role == 'manager':
        st.subheader("üë®‚Äçüíº Vis√£o Gerencial")
        st.info("Acesso a relat√≥rios regionais e m√©tricas de equipe.")
    
    else:
        st.subheader("üë§ Resumo Pessoal")
        st.info("Dados agregados e relat√≥rios b√°sicos dispon√≠veis.")

def show_clima_vendas(user_info):
    """An√°lise clima x vendas"""
    st.header("üå§Ô∏è An√°lise Clima x Vendas")
    st.info("üöß Funcionalidade ser√° implementada na pr√≥xima etapa")
    
    st.markdown("""
    ### Pr√≥ximas implementa√ß√µes:
    - üìä Correla√ß√£o entre temperatura e vendas
    - üåßÔ∏è Impacto da precipita√ß√£o nos resultados
    - üìà Gr√°ficos interativos com Plotly
    - üéØ Insights autom√°ticos
    """)

def show_serie_temporal(user_info):
    """An√°lise de s√©rie temporal"""
    st.header("üìà An√°lise de S√©rie Temporal")
    st.info("üöß Funcionalidade ser√° implementada na pr√≥xima etapa")

def show_modelo_preditivo(user_info):
    """Modelo preditivo"""
    st.header("ü§ñ Modelo Preditivo")
    st.info("üöß Funcionalidade ser√° implementada na pr√≥xima etapa")

def show_admin_panel(user_info):
    """Painel administrativo"""
    st.header("‚öôÔ∏è Painel Administrativo")
    
    tab1, tab2, tab3 = st.tabs(["üë• Usu√°rios", "üìÅ Datasets", "üìä Logs"])
    
    with tab1:
        st.subheader("Gerenciamento de Usu√°rios")
        
        # Mostrar usu√°rios cadastrados
        auth = SimpleAuthenticator()
        
        st.write("**Usu√°rios Cadastrados:**")
        for username, info in auth.users.items():
            col1, col2, col3 = st.columns([2, 2, 1])
            with col1:
                st.write(f"üë§ **{info['name']}**")
            with col2:
                st.write(f"Role: `{info['role']}`")
            with col3:
                if st.button("‚úèÔ∏è", key=f"edit_{username}"):
                    st.info(f"Editar {info['name']}")
    
    with tab2:
        st.subheader("Gerenciamento de Datasets")
        st.info("Carregar e gerenciar arquivos CSV")
        
        # Upload de arquivo
        uploaded_file = st.file_uploader("üìÅ Upload de Dataset", type=['csv'])
        if uploaded_file:
            st.success(f"Arquivo {uploaded_file.name} carregado!")
    
    with tab3:
        st.subheader("Logs do Sistema")
        st.code("""
        [2025-01-08 10:30:15] admin: Login realizado
        [2025-01-08 10:31:22] admin: Acessou dashboard
        [2025-01-08 10:35:45] usuario: Login realizado
        [2025-01-08 10:36:12] usuario: Acessou clima_vendas
        """)

def main():
    """Fun√ß√£o principal"""
    
    # Inicializar authenticator
    auth = SimpleAuthenticator()
    
    # Verificar se est√° logado
    if auth.is_logged_in():
        show_main_app()
    else:
        show_login_page()

if __name__ == "__main__":
    main()